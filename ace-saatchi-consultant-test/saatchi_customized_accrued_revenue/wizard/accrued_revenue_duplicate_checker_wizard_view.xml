<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Wizard Form View -->
    <record id="view_accrued_revenue_wizard_form" model="ir.ui.view">
        <field name="name">saatchi.accrued.revenue.wizard.form</field>
        <field name="model">saatchi.accrued_revenue.wizard</field>
        <field name="arch" type="xml">
            <form string="Create Accrued Revenue">
                <sheet>
                    <div class="oe_title">
                        <h1>System Generated Accruals</h1>
                    </div>
                    
                    <group>
                        <group>
                            <field name="accrual_date"/>
                            <field name="reversal_date"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <!-- Sale Orders Selection -->
                        <page string="Sale Orders to Process" name="sale_orders">
                            <field name="so_line_ids" nolabel="1">
                                <list string="Sale Orders" editable="bottom" create="0" delete="0" 
                                      decoration-warning="has_existing_accrual == True">
                                    <field name="create_accrual" widget="boolean_toggle"/>
                                    <field name="sale_order_id" readonly="1"/>
                                    <field name="partner_id" readonly="1"/>
                                    <field name="ce_code" readonly="1"/>
                                    <field name="amount_total" readonly="1" sum="Total For Accrue"/>
                                    <field name="currency_id" readonly="1" column_invisible="1"/>
                                    <field name="has_existing_accrual" 
                                           readonly="1" 
                                           widget="boolean_toggle"
                                           string="Already Has Accrual"/>
                                </list>
                            </field>
                        </page>
                        
                        <!-- Existing Accruals List -->
                        <page string="Existing Accruals" name="existing_accruals" invisible="not has_existing_accruals">
                            <field name="so_line_ids" nolabel="1">
                                <list string="Sale Orders with Existing Accruals" create="0" delete="0" edit="0" decoration-muted="not existing_accrual_ids">
                                    <field name="sale_order_id" string="Sale Order"/>
                                    <field name="partner_id" string="Customer"/>
                                    <field name="ce_code" string="CE Code"/>
                                    <field name="amount_total" string="SO Amount"/>
                                    <field name="currency_id" column_invisible="1"/>
                                    <field name="existing_accrual_ids" widget="many2many_tags" string="Existing Accruals (Click to Open)"/>
                                </list>
                                <form string="Existing Accruals Details">
                                    <sheet>
                                        <div class="oe_title">
                                            <h1>
                                                <field name="sale_order_id" readonly="1" class="oe_inline"/>
                                            </h1>
                                            <h3>
                                                <field name="partner_id" readonly="1"/>
                                            </h3>
                                        </div>
                                        
                                        <group>
                                            <group>
                                                <field name="ce_code" readonly="1"/>
                                                <field name="amount_total" readonly="1"/>
                                                <field name="currency_id" readonly="1"/>
                                            </group>
                                            <group>
                                                <field name="has_existing_accrual" readonly="1" widget="boolean"/>
                                                <field name="create_accrual" readonly="1" widget="boolean"/>
                                            </group>
                                        </group>
                                        
                                        <notebook>
                                            <page string="Existing Accruals for This Period" name="accruals">
                                                <field name="existing_accrual_ids" nolabel="1" readonly="1">
                                                    <list string="Accrual Records" create="0" delete="0" edit="0">
                                                        <field name="display_name" string="Accrual"/>
                                                        <field name="date" string="Accrual Date"/>
                                                        <field name="reversal_date" string="Reversal Date"/>
                                                        <field name="state" widget="badge" 
                                                               decoration-info="state == 'draft'"
                                                               decoration-success="state == 'accrued'"
                                                               decoration-warning="state == 'reversed'"
                                                               decoration-danger="state == 'cancel'"/>
                                                        <field name="total_debit_in_accrue_account" string="Accrued Amount"/>
                                                        <field name="currency_id" column_invisible="1"/>
                                                        <field name="ce_original_total_amount" string="CE Max Amount" optional="hide"/>
                                                        <field name="journal_id" optional="hide"/>
                                                    </list>
                                                </field>
                                                
                                                <div class="alert alert-info mt-3" role="alert" invisible="not existing_accrual_ids">
                                                    <i class="fa fa-info-circle"/> 
                                                    <strong>Tip:</strong> Click on any accrual row above to open the full record and view all details including journal entries.
                                                </div>
                                                
                                                <div class="alert alert-warning mt-3" role="alert" invisible="existing_accrual_ids">
                                                    <i class="fa fa-exclamation-triangle"/> 
                                                    No existing accruals found for this sale order in the current period.
                                                </div>
                                            </page>
                                        </notebook>
                                    </sheet>
                                </form>
                            </field>
                        </page>
                    </notebook>
                    
                    <div class="alert alert-warning" role="alert" style="margin-top: 10px;">
                        <strong>Note:</strong> Some sale orders already have accruals for this period (marked in yellow). 
                        If you proceed, new accruals will be created for the selected orders.
                    </div>
                </sheet>
                
                <footer>
                    <button string="Create Selected Accruals" 
                            type="object" 
                            name="action_create_accruals" 
                            class="btn-primary"
                            data-hotkey="q"/>
                    <button string="Cancel" 
                            class="btn-secondary" 
                            special="cancel"
                            data-hotkey="z"/>
                </footer>
            </form>
        </field>
    </record>


    <!-- Wizard Action -->
    <record id="action_accrued_revenue_wizard" model="ir.actions.act_window">
        <field name="name">Create Accrued Revenue</field>
        <field name="res_model">saatchi.accrued_revenue.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="binding_model_id" ref="model_saatchi_accrued_revenue"/>
        <field name="binding_view_types">list</field>
    </record>

</odoo>