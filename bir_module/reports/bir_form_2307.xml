<?xml version="1.0" encoding='utf-8'?>
<odoo>

	<!-- Paper Format for Legal Size - MUST BE FIRST -->
	<record id="paperformat_bir_legal" model="report.paperformat">
		<field name="name">BIR Legal</field>
		<field name="default" eval="False"/>
		<field name="format">custom</field>
		<field name="page_height">330</field>
		<field name="page_width">216</field>
		<field name="orientation">Portrait</field>
		<field name="margin_top">0</field>
		<field name="margin_bottom">0</field>
		<field name="margin_left">0</field>
		<field name="margin_right">0</field>
		<field name="header_line" eval="False"/>
		<field name="header_spacing">0</field>
		<field name="dpi">96</field>
	</record>

	<!-- Report Action - REFERENCES paperformat above -->
	<record id="2307_report_action_id_multi" model="ir.actions.report">
		<field name="name">BIR Form 2307 multi</field>
		<field name="model">account.move</field>
		<field name="report_type">qweb-pdf</field>
		<field name="report_name">bir_module.form_2307</field>
		<field name="report_file">bir_module.form_2307</field>
		<field name="binding_type">report</field>
		<field name="paperformat_id" ref="bir_module.paperformat_bir_legal"/>
		<field name="print_report_name">'BIR Form 2307 - %s' % (object.partner_id.name)</field>
	</record>

	<template id="form_2307">
		<t t-call='web.basic_layout'>

			<t t-set="company_id" t-value="env['account.move'].x_fetch_company_id()"/>
			<t t-set="report_id" t-value="request.params.get('id', id)"/>
			<t t-set="report_month" t-value="request.params.get('month', month)"/>
			<t t-set="report_trigger" t-value="request.params.get('trigger', trigger)"/>
			<t t-set="report_tranid" t-value="request.params.get('tranid', tranid)"/>
			<t t-set="search_param" t-value="request.params.get('search', '')"/>
			<t t-set="checked_ids_param" t-value="request.params.get('checked_ids', '[]')"/>
			<!-- Parse JSON array of selected move IDs from frontend checkboxes -->
			<t t-set="checked_ids" t-value="env['account.move']._parse_checked_ids(checked_ids_param)"/>
			<!-- Fetch form data, filtered by selected records if checkboxes were used -->
			<t t-set="values" t-value="env['account.move'].x_get_2307_data([[int(report_id), report_month], 'not_transactional', report_trigger, '2307-Quarterly', report_tranid, search_param, checked_ids])"/>
			<t t-set='company' t-value="request.env['res.company'].search([('id', '=', company_id)])"/>
			<t t-set='payor' t-value="request.env['res.partner'].search([('id', '=', company.partner_id.id)])"/>
			<t t-set='payee' t-value="request.env['res.partner'].search([('id', '=', int(report_id))])"/>

			<!-- OFFSET CONTROLS - Adjust these to move the entire form -->
			<t t-set="offset_top" t-value="5"/>     <!-- Add/subtract mm to move everything up/down -->
			<t t-set="offset_left" t-value="-5"/>    <!-- Add/subtract mm to move everything left/right -->

			<div class="page" style="width: 260mm; height: 390mm; margin: 0; padding: 0; position: relative;">

				<div style="background-image: url('/bir_module/static/img/2307.jpg'); background-repeat: no-repeat; background-size: 262mm 392mm; width: 262mm; height: 392mm; position: absolute; top: 0; left: 0;">
					
					<!-- Part I - For the Period -->
					<t t-set="period" t-value="env['account.move'].fetch_period_dates(report_month) if report_month else []"/>
					
					<!-- From: Month Day Year -->
					<div class="left" t-attf-style="position: absolute;  top: #{39 + offset_top}mm; left: #{68 + offset_left}mm;letter-spacing:11px; font-size:11pt;">
						<span><t t-esc="period[1] if len(period) > 1 else ''"/></span>
						<span style="margin-left: 4px">01</span>
						<span style="margin-left: 4px"><t t-esc="period[5] if len(period) > 5 else ''"/></span>
					</div>
					<!-- To: Month Day Year -->
					<div class="right" t-attf-style="position: absolute;  top: #{39 + offset_top}mm; left: #{179 + offset_left}mm; letter-spacing:11px; font-size:11pt;">
						<span><t t-esc="period[2] if len(period) > 2 else ''"/></span>
						<span style="margin-left: 4px"><t t-esc="period[4] if len(period) > 4 else ''"/></span>
						<span style="margin-left: 4px"><t t-esc="period[5] if len(period) > 5 else ''"/></span>
					</div>
					

					<!-- Part II - Payee Information -->
					<t t-set="payee_vat" t-value="env['account.move'].x_slice_vat(payee.vat)"/>
					
					<!-- Payee TIN (4 boxes) -->
					<div t-attf-style="position: absolute; top: #{53 + offset_top}mm; left: #{93 + offset_left}mm; letter-spacing: 11px; font-size: 11pt;">
						<t t-esc="payee_vat[0] if len(payee_vat) > 0 else ''"/>
					</div>
					<div t-attf-style="position: absolute; top: #{53 + offset_top}mm; left: #{116 + offset_left}mm; letter-spacing: 11px; font-size: 11pt;">
						<t t-esc="payee_vat[1] if len(payee_vat) > 1 else ''"/>
					</div>
					<div t-attf-style="position: absolute; top: #{53 + offset_top}mm; left: #{139 + offset_left}mm; letter-spacing: 11px; font-size: 11pt;">
						<t t-esc="payee_vat[2] if len(payee_vat) > 2 else ''"/>
					</div>
					<div t-attf-style="position: absolute; top: #{53 + offset_top}mm; left: #{163 + offset_left}mm; letter-spacing: 11px; font-size: 11pt;">
						<t t-esc="payee_vat[3] if len(payee_vat) > 3 else ''"/>
					</div>

					<!-- Payee Registered Name -->
					<div t-attf-style="position: absolute; top: #{65 + offset_top}mm; left: #{14 + offset_left}mm; font-size: 10pt; white-space: nowrap;">
					<t t-esc="(payee.name or '').replace('| Trade', '').strip() if payee.name else ''"/>
				</div>
					<div t-attf-style="position: absolute; top: #{78 + offset_top}mm; left: #{14 + offset_left}mm; font-size: 10pt; white-space: nowrap;">
						<t t-esc="payee.contact_address_complete"/>
					</div>
					
					<!-- Payee ZIP Code -->
					<div t-attf-style="position: absolute; top: #{78 + offset_top}mm; left: #{243 + offset_left}mm; letter-spacing: 11px; font-size: 11pt;">
						<t t-esc="payee.zip or ''"/>
					</div>

					<!-- Part III - Payor Information -->
					<t t-set="payor_vat" t-value="env['account.move'].x_slice_vat(payor.vat)"/>
					
					<!-- Payor TIN (4 boxes) -->
					<div t-attf-style="position: absolute; top: #{105 + offset_top}mm; left: #{93 + offset_left}mm; letter-spacing: 11px; font-size: 11pt;">
						<t t-esc="payor_vat[0] if len(payor_vat) > 0 else ''"/>
					</div>
					<div t-attf-style="position: absolute; top: #{105 + offset_top}mm; left: #{116 + offset_left}mm; letter-spacing: 11px; font-size: 11pt;">
						<t t-esc="payor_vat[1] if len(payor_vat) > 1 else ''"/>
					</div>
					<div t-attf-style="position: absolute; top: #{105 + offset_top}mm; left: #{139 + offset_left}mm; letter-spacing: 11px; font-size: 11pt;">
						<t t-esc="payor_vat[2] if len(payor_vat) > 2 else ''"/>
					</div>
					<div t-attf-style="position: absolute; top: #{105 + offset_top}mm; left: #{163 + offset_left}mm; letter-spacing: 11px; font-size: 11pt;">
						<t t-esc="payor_vat[3] if len(payor_vat) > 3 else ''"/>
					</div>

					<!-- Payor Registered Name -->
					<div t-attf-style="position: absolute; top: #{117 + offset_top}mm; left: #{14 + offset_left}mm; font-size: 10pt; white-space: nowrap;">
					<t t-esc="(payor.name or '').replace('| Trade', '').strip() if payor.name else ''"/>
				</div>
					<div t-attf-style="position: absolute; top: #{130 + offset_top}mm; left: #{14 + offset_left}mm; font-size: 11pt; white-space: nowrap;">
						<t t-esc="payor.contact_address_complete"/>
					</div>
					
					<!-- Payor ZIP Code -->
					<div t-attf-style="position: absolute; top: #{130 + offset_top}mm; left: #{243 + offset_left}mm; letter-spacing: 11px; font-size: 11pt;">
						<t t-esc="payor.zip or ''"/>
					</div>

					<!-- Part III - Details of Income Payments and Taxes Withheld -->
					<t t-if="len(values[0]) > 0">
						<t t-set="processed" t-value="env['account.move'].process_2307_quarterly(values[0])"/>
						<div t-attf-style="position: absolute; top: #{155 + offset_top}mm; left: #{7 + offset_left}mm; width: 262mm; font-size: 10pt; line-height: 1.4;">
							<t t-foreach="processed" t-as="val">
								<div style="display: table; margin-bottom: 2mm; padding-top: 0.5mm">
									<!-- Nature of Income Payment -->
									<div style="display: table-cell; width: 70mm; text-align: left;  vertical-align: top; line-height: 1.75; font-size: 9.5pt;">
										<t t-esc='val["desc"]'/>
									</div>
									<!-- ATC -->
									<div style="display: table-cell; width: 20mm; text-align: center; vertical-align: top;">
										<t t-esc='val["code"]'/>
									</div>
									<!-- 1st Month -->
									<div style="display: table-cell; width: 32mm; text-align: right; padding-right: 2mm; vertical-align: top;">
										<t t-esc='"{:,.2f}".format(val["m1"])'/>
									</div>
									<!-- 2nd Month -->
									<div style="display: table-cell; width: 33mm; text-align: right; padding-right: 2mm; vertical-align: top;">
										<t t-esc='"{:,.2f}".format(val["m2"])'/>
									</div>
									<!-- 3rd Month -->
									<div style="display: table-cell; width: 33mm; text-align: right; padding-right: 2mm; vertical-align: top;">
										<t t-esc='"{:,.2f}".format(val["m3"])'/>
									</div>
									<!-- Total -->
									<div style="display: table-cell; width: 33mm; text-align: right; padding-right: 2mm; vertical-align: top;">
										<t t-esc='"{:,.2f}".format(val["m_total"])'/>
									</div>
									<!-- Tax Withheld -->
									<div style="display: table-cell; width: 36mm; text-align: right; padding-right: 2mm; vertical-align: top;">
										<t t-esc='"{:,.2f}".format(val["taxed"])'/>
									</div>
								</div>
							</t>
							<!-- TOTALS ROW -->
							<t t-set="total_m1" t-value="sum([val['m1'] for val in processed])"/>
							<t t-set="total_m2" t-value="sum([val['m2'] for val in processed])"/>
							<t t-set="total_m3" t-value="sum([val['m3'] for val in processed])"/>
							<t t-set="total_m_total" t-value="sum([val['m_total'] for val in processed])"/>
							<t t-set="total_taxed" t-value="sum([val['taxed'] for val in processed])"/>
							<div t-attf-style="position: absolute; top: #{88 + offset_top}mm; left: #{5 + offset_left}mm; width: 262mm; font-size: 10pt; line-height: 1.4;">
								<div style="display: table; margin-bottom: 2.5mm;  padding-top: 2px; font-weight: bold;">
									<!-- Nature of Income Payment -->
									<div style="display: table-cell; width: 70mm; text-align: left; padding-left: 1.5mm; vertical-align: middle;">
										<!-- TOTAL -->
									</div>
									<!-- ATC -->
									<div style="display: table-cell; width: 20mm; text-align: center; vertical-align: middle;">
									</div>
									<!-- 1st Month Total -->
									<div style="display: table-cell; width: 32mm; text-align: right; padding-right: 1.5mm; vertical-align: middle;">
										<t t-esc='"{:,.2f}".format(total_m1)'/>
									</div>
									<!-- 2nd Month Total -->
									<div style="display: table-cell; width: 33mm; text-align: right; padding-right: 1.5mm; vertical-align: middle;">
										<t t-esc='"{:,.2f}".format(total_m2)'/>
									</div>
									<!-- 3rd Month Total -->
									<div style="display: table-cell; width: 33mm; text-align: right; padding-right: 1.5mm; vertical-align: middle;">
										<t t-esc='"{:,.2f}".format(total_m3)'/>
									</div>
									<!-- Grand Total -->
									<div style="display: table-cell; width: 33mm; text-align: right; padding-right: 1.5mm; vertical-align: middle;">
										<t t-esc='"{:,.2f}".format(total_m_total)'/>
									</div>
									<!-- Tax Withheld Total -->
									<div style="display: table-cell; width: 36mm; text-align: right; padding-right: 1.5mm; vertical-align: middle;">
										<t t-esc='"{:,.2f}".format(total_taxed)'/>
									</div>
								</div>
							</div>
						</div>
					</t>
				</div>
				<div style="position: absolute; top: 326mm; left: 6mm; text-align: center; width: 250mm;">
				<!-- DYNAMIC SIGNEE TAX AGENT INFORMATION -->
				<t t-set="signee_info" t-value="env['bir_module.signee_setup'].get_signee_by_id(int(request.params.get('signee_id', 0)))"/>
			<div>
				<span style="font-weight: bold; font-size: 10pt; margin-bottom: 10px; padding-left: 70px; padding-right: 70px; white-space: nowrap;"><t t-esc="signee_info.get('name', '')"/></span>
				<span style="font-weight: bold; font-size: 10pt; margin-bottom: 10px; padding-left: 70px; padding-right: 70px; white-space: nowrap;"><t t-esc="signee_info.get('tax_id', '')"/></span>
				<span style="font-weight: bold; font-size: 10pt; padding-left: 70px; padding-right: 70px; white-space: nowrap;"><t t-esc="signee_info.get('position', '')"/></span>
				</div>
				</div>
			</div>
		</t>
	</template>

</odoo>